---
layout: post
title: "EMR jupyterhub 계정관리시 명령어 예시"
tags: [Data Engineering]
comments: true
---

.

Data_Engineering_TIL(20201101)


** 학습시 참고한 레퍼런스 : https://docs.aws.amazon.com/emr/latest/ReleaseGuide/emr-jupyterhub-pam-users.html


### [주피터허브에 사용자 계정 추가하는 bash 스크립트 예시]

- Jupyterhub_add_user.sh


```python
#!/bin/bash

############################################
# Add user for jupyterhub
############################################

cd /etc/jupyter/conf
echo "c.LocalAuthenticator.create_system_users = True" | sudo tee -a jupyterhub_config.py
sudo docker restart jupyterhub

############################################
# Add user for jupyterhub
############################################

user=john
password=$(echo "bXlwYXNzd2Q=" | base64 -d)
# bXlwYXNzd2Q= : mypasswd

sudo docker exec jupyterhub useradd -m -s /bin/bash -N ${user}
sudo docker exec jupyterhub bash -c "echo ${user}:${password} | chpasswd"

############################################
# Add admin power for jupyterhub user
############################################

endpoint_url="https://$(hostname):9443/hub/api/users/${user}"
token=$(sudo docker exec jupyterhub /opt/conda/bin/jupyterhub token jovyan | tail -1)

curl -XPOST --silent -k ${endpoint_url} -H "Authorization: token $token"
curl -XPATCH --silent -k ${endpoint_url} -H "Authorization: token $token" -d '{"admin":true}'
```

### [주피터허브에 계정정보를 s3에 백업하는 bash 스크립트 예시]

- backup_my_jupyterhub_user_info.sh


```python
#!/bin/bash

cd ~/
bucket_name=pms-bucket-test

# container에서 user 정보 복사
sudo docker cp jupyterhub:/home/jovyan/jupyterhub.sqlite ~/
# 명령어 실행시 ~/ 에 jupyterhub.sqlite 가 생성됨

# S3에 백업
aws s3 cp ~/jupyterhub.sqlite s3://${bucket_name}/jupyterhub_user_info/

# container에서 비밀번호 정보 복사
sudo docker cp jupyterhub:/etc/shadow ~/
# 명령어 실행시 ~/ 에 shadow 파일이 생성됨

# 비밀번호 파일 권한 변경(other에 읽기 권한이 없어서 S3에 백업이 불가하기 때문)
sudo chmod 644 ~/shadow

# S3에 백업
aws s3 cp ~/shadow s3://${bucket_name}/jupyterhub_user_info/
```

### [s3에 백업한 주피터허브 계정정보를 복원하는 bash 스크립트 예시]

- restore_my_jupyterhub_user_info.sh


```python
#!/bin/bash

# jupyterhub config file이 있는 디렉토리로 이동
cd /etc/jupyter/conf
echo "c.LocalAuthenticator.create_system_users = True" | sudo tee -a jupyterhub_config.py

# jupyterhub 재실행
sudo docker restart jupyterhub

cd ~/

bucket_name=pms-bucket-test

# 백업된 user 정보 받아오기
aws s3 cp s3://${bucket_name}/jupyterhub_user_info/jupyterhub.sqlite ~/

# 백업된 user 정보 container에 overwrite
sudo docker cp ~/jupyterhub.sqlite jupyterhub:/home/jovyan/jupyterhub.sqlite

# 백업된 비밀번호 정보 받아오기
aws s3 cp s3://${bucket_name}/jupyterhub_user_info/shadow ~/shadow

# 백업된 비밀번호 정보 container에 overwrite
sudo docker cp ~/shadow jupyterhub:/etc/shadow

# 비밀정보 파일 권한 원래대로 복원
sudo docker exec jupyterhub bash -c "chown root:shadow /etc/shadow"
sudo docker exec jupyterhub bash -c "chmod 640 /etc/shadow"


# Jupyterhub 재실행
# 주의사항 : 반드시 jupyterhub webui에서 복사해온 계정정보대로 계정별로 로그인을 최초로 해줘야한다.
# 그러지 않고 주피터허버를 재시작하면 비밀번호 토큰정보가 날아가버린다.
sudo docker restart jupyterhub
```

### [여러개의 계정정보 추가하는 부트스트랩 쉘스크립트 예시]


기존에 운영하던 EMR을 terminate 시키고 새로운 EMR을 띄워야 하는 상황이라고 가정하자. 그런데 관리자는 기존에 EMR에서 쓰던 주피터 허브 계정정보를 쓰고 싶다고 한다면 어떻게 해야할까. 아래와 같은 쉘스크립트를 EMR 구동시 부트스트랩 옵션으로 적용해주면 된다.


- bootstrap.sh

Bulk add users to container and JupyterHub with temp password of username


```python
#!/bin/bash

set -x
USERS=(minman2115 jovyan jisungpark13 rooney0515)
TOKEN=$(sudo docker exec jupyterhub /opt/conda/bin/jupyterhub token jovyan | tail -1)
for i in "${USERS[@]}"; 
do 
   sudo docker exec jupyterhub useradd -m -s /bin/bash -N $i
   sudo docker exec jupyterhub bash -c "echo $i:$i | chpasswd"
   curl -XPOST --silent -k https://$(hostname):9443/hub/api/users/$i \
 -H "Authorization: token $TOKEN" | jq
done
```

### [EMR 마스터노드에서 jupyter hub root로 들어가는 방법]

주피터허브는 컨테이너 환경이기 때문에 아래와 같은 명령어를 실행하면 주피터허브라는 컨테이너의 루트로 접속하게 된다. 거기에서 필요한 것들을 관리해주면 된다.


```python
[hadoop@ip-10-0-5-185 ~]$ sudo docker exec -it jupyterhub /bin/bash

root@jupyterhub:~# id
uid=0(root) gid=0(root) groups=0(root)

root@jupyterhub:~# cd ..

root@jupyterhub:/home# ls
minman2115  jovyan  jisungpark13  rooney0515

root@jupyterhub:/home#
```
