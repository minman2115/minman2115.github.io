---
layout: post
title: "EC2를 이용한 ElasticSearch Cluster 구현하기 - 코디네이터 노드 중심 클러스터 구성"
tags: [Data Engineering]
comments: true
---

.

Data_Engineering_TIL(20210924)

### [참고자료]

- "ES Cluster 구성" 최정민님 깃허브 자료

URL : https://github.com/cjungm/with-aws/tree/main/ElasticSearch/installed_ES

- "Elastic Cluster 구성" 김종민(kimjmin@gmail.com)님 블로그글

URL : http://kimjmin.net/2018/01/2018-01-build-es-cluster-1/

### [참고사항]

- "EC2를 이용한 ElasticSearch Cluster 구현하기 - 클러스터 구성"와 동일한 단계의 실습이라고 이해하면 되고, 실습하는 방법도 유사하나 클러스터 구성을 어떻게 할건지에 대해서는 차이가 있다.

URL : https://minman2115.github.io/DE_TIL272/

- 구현하고자 하는 클러스터 아키텍처

** 아래 아키텍처 이미지 출처  : "Elastic Cluster 구성 5" 김종민(kimjmin@gmail.com)님 블로그글

(URL : http://kimjmin.net/2018/01/2018-01-build-es-cluster-5/)

![2](https://user-images.githubusercontent.com/41605276/133754435-5edd66d0-411b-40d4-be02-2bba8b5cc020.png)

1) 데이터노드 1~3개 중 임의의 노드 하나가 마스터 노드를 겸하게 된다.

2) 기존 마스터 노드는 코디네이트 노드로 Kibana 및 다른 애플리케이션과의 통신만 처리하게 된다.

3) 코디네이트 노드는 다른 애플리케이션과 REST API를 사용한다.(9200 포트)

4) 코디네이트 노드와 데이터 노드들은 transport 프로토콜(9300 포트)로 데이터를 교환한다.

5) 데이터 노드들은 REST API를 사용하지 않도록 설정한다. http.enabled: false

6) 코디네이트 노드 서버의 /usr/share/elasticsearch 디렉토리를 데이터 노드와 공유한다.

7) 보안그룹 1은 코디네이트 노드 서버에만 적용 되며 허가된 포트로만 외부 클라이언트와 통신이 가능하도록 한다.

8) 보안그룹 2는 모든 서버에 적용되며 이 그룹 안의 서버들 끼리는 자유롭게 통신이 가능하도록 한다.

### [실습내용]

- 실습순서

STEP 1) 서버 생성 및 Elasticsearch 설치

STEP 2) 메모리, 네트워크 설정 및 플러그인 설치

STEP 3) 클러스터 구성 및 코디네이트, 데이터 노드 설정

STEP 4) Kibana 설치 및 X-Pack Monitoring 확인

STEP 5) NFS 구성 및 elasticsearch 추가 설정

STEP 6) X-Pack Security를 이용한 SSL 및 TLS 설정

STEP 7) X-Pack License 적용 및 사용자 생성

STEP 8) Logstash 설치 및 Elasticsearch 기본 템플릿 설정


- STEP 1) 서버 생성 및 Elasticsearch 설치


서버들을 클러스터로 만들려면 이 서버들 끼리는 통신이 가능하도록 보안 그룹을 설정을 해야한다. 보안 그룹을 하나 만들고 나서 소스에 해당 보안 그룹의 id를 적으면 그 보안그룹에 소속된 인스턴스 끼리 자유롭게 통신이 가능하다.

ES를 생성할 vpc의 아이피 대역을 확인한다음 보안그룹을 만들어준다.

![3](https://user-images.githubusercontent.com/41605276/131210191-96a2d6fa-f3b7-48af-b548-824793ec8e9f.png)

그런다음에 위에서 만든 마스터 노드의 보안그룹을 이용해서 m5.xlarge type으로 코디네이트 노드 서버(EC2)를 생성한 다음, 생성한 EC2로 접속해서 아래와 같이 명령어를 실행해준다.

이 EC2를 코디네이트 노드로 사용할 것이다.


```console
# yum update
[ec2-user@ip-10-10-1-146 ~]$ sudo yum update -y

# 서버의 기준시간 변경 : 서버의 초기 시간 설정이 UTC로 되어 있는데, 대한민국 서울 시간으로 변경
[ec2-user@ip-10-10-1-146 ~]$ sudo cp -p /usr/share/zoneinfo/Asia/Seoul /etc/localtime

[ec2-user@ip-10-10-1-146 ~]$ date
Sat Aug 28 13:16:26 KST 2021

# Java 업그레이드
# Elasticsearch 를 지원하는 Java 버전은 Support Matrix 페이지에서 확인이 가능함. 1.8 버전에서 안정적으로 사용이 가능
# Amazon Linux2 는 CentOS 기반이기 때문에 Yum 설치가 가능함. Java를 1.8로 설치
# Support Matrix 페이지 : https://www.elastic.co/kr/support/matrix#matrix_jvm
[ec2-user@ip-10-10-1-146 ~]$ sudo yum install java-1.8.0-openjdk-devel.x86_64 -y

# Elasticsearch 설치
# 아래의 링크를 참고하여 elasticsearch 를 yum 을 이용한 rpm 으로 설치
# https://www.elastic.co/guide/en/elasticsearch/reference/current/rpm.html
# 최신 버전의 elasticsearch를 yum 으로 설치하기 위해서는 /etc/yum.repos.d/ 디렉토리 아래에 
# elasticsearch.repo 파일을 만들고 아래와 같이 내용을 입력
[ec2-user@ip-10-10-1-146 ~]$ cd /etc/yum.repos.d/

[ec2-user@ip-10-10-1-146 yum.repos.d]$ sudo vim elasticsearch.repo
[elasticsearch]
name=Elasticsearch repository for 7.x packages
baseurl=https://artifacts.elastic.co/packages/7.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=0
autorefresh=1
type=rpm-md

# 위와 같이 파일을 추가하고 나서 이제 yum을 이용해서 Elasticsearch를 설치
[ec2-user@ip-10-10-1-146 yum.repos.d]$ cd ~

# elasticsearch 7.14.0-1 
[ec2-user@ip-10-10-1-146 ~]$ sudo yum install --enablerepo=elasticsearch elasticsearch -y
Loaded plugins: extras_suggestions, langpacks, priorities, update-motd
elasticsearch                                                                                                                                                      | 1.3 kB  00:00:00
elasticsearch/primary                                                                                                                                              | 306 kB  00:00:00
elasticsearch                                                                                                                                                                     941/941
Resolving Dependencies
--> Running transaction check
---> Package elasticsearch.x86_64 0:7.14.0-1 will be installed
--> Finished Dependency Resolution

Dependencies Resolved

==========================================================================================================================================================================================
 Package                                        Arch                                    Version                                      Repository                                      Size
==========================================================================================================================================================================================
Installing:
 elasticsearch                                  x86_64                                  7.14.0-1                                     elasticsearch                                  328 M

Transaction Summary
==========================================================================================================================================================================================
Install  1 Package

Total download size: 328 M
Installed size: 537 M
Downloading packages:
warning: /var/cache/yum/x86_64/2/elasticsearch/packages/elasticsearch-7.14.0-x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID d88e42b4: NOKEY========-]  10 MB/s | 326 MB  00:00:00 ETA
Public key for elasticsearch-7.14.0-x86_64.rpm is not installed
elasticsearch-7.14.0-x86_64.rpm                                                                                                                                    | 328 MB  00:00:42
Retrieving key from https://artifacts.elastic.co/GPG-KEY-elasticsearch
Importing GPG key 0xD88E42B4:
 Userid     : "Elasticsearch (Elasticsearch Signing Key) <dev_ops@elasticsearch.org>"
 Fingerprint: 4609 5acc 8548 582c 1a26 99a9 d27d 666c d88e 42b4
 From       : https://artifacts.elastic.co/GPG-KEY-elasticsearch
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
Creating elasticsearch group... OK
Creating elasticsearch user... OK
  Installing : elasticsearch-7.14.0-1.x86_64                                                                                                                                          1/1
### NOT starting on installation, please execute the following statements to configure elasticsearch service to start automatically using systemd
 sudo systemctl daemon-reload
 sudo systemctl enable elasticsearch.service
### You can start elasticsearch service by executing
 sudo systemctl start elasticsearch.service
Created elasticsearch keystore in /etc/elasticsearch/elasticsearch.keystore
  Verifying  : elasticsearch-7.14.0-1.x86_64                                                                                                                                          1/1

Installed:
  elasticsearch.x86_64 0:7.14.0-1

Complete!

# elasticsearch rpm 설치 문서에 나와 있는대로 ps -p 1 를 이용해서 SysV init 과 systemd 중 어떤 서비스를 사용하는지 확인
[ec2-user@ip-10-10-1-146 ~]$ ps -p 1
  PID TTY          TIME CMD
    1 ?        00:00:01 systemd
            
# systemd 를 사용하는것이 확인되었고, 그러면 서비스에 등록하기 위해 다음 명령을 실행한다.
# 만약에 init의 경우는 자동실행을 위한 service 등록을 아래와 같이 해주면 된다.
# $ sudo chkconfig --add elasticsearch
# systemd는 자동실행을 위한 system demon 등록을 위해 아래와 같이 명령어를 실행해준다.

[ec2-user@ip-10-10-1-146 ~]$ sudo /bin/systemctl daemon-reload

[ec2-user@ip-10-10-1-146 ~]$ sudo /bin/systemctl enable elasticsearch.service
Created symlink from /etc/systemd/system/multi-user.target.wants/elasticsearch.service to /usr/lib/systemd/system/elasticsearch.service.

# 위와 같이 등록을 해주면 Elasticsearch는 이제 service 명령으로 실행 또는 종료가 가능하다.
# [init의 경우]
# $ sudo -i service elasticsearch start
# Starting elasticsearch (via systemctl):                    [  OK  ]
# $ sudo -i service elasticsearch stop
# Stopping elasticsearch (via systemctl):                    [  OK  ]
# systemd의 경우는 아래와 같이 명령어를 실행해준다.
[ec2-user@ip-10-10-1-146 ~]$ sudo systemctl start elasticsearch.service
# $ sudo systemctl stop elasticsearch.service 명령어로 정지도 가능하다.

[ec2-user@ip-10-10-1-146 ~]$ sudo systemctl status elasticsearch.service
● elasticsearch.service - Elasticsearch
   Loaded: loaded (/usr/lib/systemd/system/elasticsearch.service; enabled; vendor preset: disabled)
   Active: active (running) since Sat 2021-08-28 13:17:26 KST; 3s ago
     Docs: https://www.elastic.co
 Main PID: 7362 (java)
   CGroup: /system.slice/elasticsearch.service
           ├─7362 /usr/share/elasticsearch/jdk/bin/java -Xshare:auto -Des.networkaddress.cache.ttl=60 -Des.networkaddress.cache.negative.ttl=10 -XX:+AlwaysPreTouch -Xss1m -Djava.awt.h...
           └─7564 /usr/share/elasticsearch/modules/x-pack-ml/platform/linux-x86_64/bin/controller

Aug 28 13:17:08 ip-10-10-1-146.ap-northeast-2.compute.internal systemd[1]: Starting Elasticsearch...
Aug 28 13:17:26 ip-10-10-1-146.ap-northeast-2.compute.internal systemd[1]: Started Elasticsearch.

# 호스트명 변경
# 호스트명을 변경하기 위해서는 Amazon Linux 2: hostnamectl 명령으로 호스트 이름을 설정하여 정규화된 도메인 이름을 반영 해준다.
[ec2-user@ip-10-10-1-146 ~]$ sudo hostnamectl set-hostname es-coordinater

[ec2-user@ip-10-10-1-146 ~]$ hostname
es-coordinater

# 위와 같이 호스트네임을 바꾼것은 추후 설정 및 모니터링을 편의성이 목적이며 생성하는 각 인스턴스 별로 
# HOSTNAME=es-coordinater, HOSTNAME=es-data-1, HOSTNAME=es-data-2 , HOSTNAME=es-data-3 등과 같이 설정할 것이다.
# elasticsearch 서비스는 자동으로 잘 실행 되는지 아래와 같이 확인해본다.
[ec2-user@ip-10-10-1-146 ~]$ curl localhost:9200
{
  "name" : "ip-10-10-1-146.ap-northeast-2.compute.internal",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "dFOYiQ7RRGiurpSiIdPaPQ",
  "version" : {
    "number" : "7.14.0",
    "build_flavor" : "default",
    "build_type" : "rpm",
    "build_hash" : "dd5a0a2acaa2045ff9624f3729fc8a6f40835aa1",
    "build_date" : "2021-07-29T20:49:32.864135063Z",
    "build_snapshot" : false,
    "lucene_version" : "8.9.0",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}
```

위와같이 완료했으면 Elasticsearch 설정을 해줘야 한다.

** RPM 버전의 기본적인 설치 경로

1) 기본 프로그램 ($ES_HOME) : /usr/share/elasticsearch

실행 파일 : bin/elasticsearch

플러그인 : plugins

2) 설정파일 : elasticsearch.yml

jvm.options

log4j2.properties

3) 데이터 (path.data) : /var/lib/elasticsearch

4) 로그 (path.logs) : /var/log/elasticsearch

데이터와 로그 파일의 경로는 /etc/elasticsearch/elasticsearch.yml 설정 파일에서 수정이 가능 모든 경로에 접근하기 위해서는 기본적으로 root 권한을 필요

예를 들어 elasticsearch.yml 설정 파일을 vim 으로 편집하려고 하면 다음과 같이 실행해준다.

Elasticsearch의 기본 클러스터명은 elasticsearch 로 되어 있는데 Elasticsearch의 노드들은 클러스터명을 기준으로 바인딩이 되기 때문에 처음 설치가 끝나면 우선적으로 클러스터명을 바꿔 줘야 나중에 실수로 노드가 엉뚱한 클러스터에 바인딩 되는 것을 막을 수 있다. elasticsearch.yml설정 파일을 열고 먼저 클러스터명을 변경해준다.


```console
[ec2-user@ip-10-10-1-146 ~]$ sudo vim /etc/elasticsearch/elasticsearch.yml

################################################################################
# 원본파일 내용
################################################################################


# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
#bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
#
#network.host: 192.168.0.1
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true

################################################################################



################################################################################
# 수정후 내용
################################################################################


# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
cluster.name: es-demo
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
node.name: ${HOSTNAME}
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
#bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
#
#network.host: 192.168.0.1
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true

################################################################################

# 이제 elasticsearch 를 재시작하여 노드명과 클러스터명이 정상적으로 반영이 되었는지를 확인한다.
[ec2-user@ip-10-10-1-146 ~]$ sudo systemctl restart elasticsearch.service

[ec2-user@ip-10-10-1-146 ~]$ curl localhost:9200
{
  "name" : "es-coordinater",
  "cluster_name" : "es-demo",
  "cluster_uuid" : "dFOYiQ7RRGiurpSiIdPaPQ",
  "version" : {
    "number" : "7.14.0",
    "build_flavor" : "default",
    "build_type" : "rpm",
    "build_hash" : "dd5a0a2acaa2045ff9624f3729fc8a6f40835aa1",
    "build_date" : "2021-07-29T20:49:32.864135063Z",
    "build_snapshot" : false,
    "lucene_version" : "8.9.0",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}
```

여기까지 진행하면 Elasticsearch의 기본 설치가 완료된 것이다.

- STEP 2) 메모리, 네트워크 설정 및 플러그인 설치

1) Java Heap 메모리 설정.

Java Heap 메모리는 jvm.options 파일에서 설정한다

코디네이트 노드는 2GB, 데이터 노드는 추후에 8GB로 각각 설정을 할 것임.

코디네이트 서버에서 아래와 같이 명령어를 실행한다. 


```console
[ec2-user@ip-10-10-1-146 ~]$ sudo vim /etc/elasticsearch/jvm.options
################################################################
## 변경전
################################################################

...

################################################################
## IMPORTANT: JVM heap size
################################################################
##
## The heap size is automatically configured by Elasticsearch
## based on the available memory in your system and the roles
## each node is configured to fulfill. If specifying heap is
## required, it should be done through a file in jvm.options.d,
## and the min and max should be set to the same value. For
## example, to set the heap to 4 GB, create a new file in the
## jvm.options.d directory containing these lines:
##
##-Xms4g
##-Xmx4g
##
## See https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html
## for more information
##
################################################################

...


################################################################
## 변경후
################################################################

...


################################################################
## IMPORTANT: JVM heap size
################################################################
##
## The heap size is automatically configured by Elasticsearch
## based on the available memory in your system and the roles
## each node is configured to fulfill. If specifying heap is
## required, it should be done through a file in jvm.options.d,
## and the min and max should be set to the same value. For
## example, to set the heap to 4 GB, create a new file in the
## jvm.options.d directory containing these lines:
##
-Xms2g
-Xmx2g
##
## See https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html
## for more information
##
################################################################

...
```

Java Heap 외에 시스템 메모리의 절반은 루씬 파일 캐시를 위해 남겨둬야 합니다.

자세한 설명이 아래 블로그들에 나와 있으니 한번은 꼭 읽어본다.

Elasticsearch 인덱싱에 대한 성능 고려 사항 : https://www.elastic.co/kr/blog/a-heap-of-trouble

Elasticsearch 2.0 인덱싱 성능 고려사항 : https://www.elastic.co/kr/blog/elasticsearch-performance-indexing-2-0

A Heap of Trouble: Managing Elasticsearch’s Managed Heap : https://www.elastic.co/kr/blog/performance-considerations-elasticsearch-indexing

2) 네트워크 설정

네트워크 설정은 elasticsearch.yml 설정 파일의 network.host 부분을 수정한다.

보통은 network.host: 192.168.0.1 과 같은 형식으로 IP 주소를 직접 입력해도 되지만, 더 간편하게 `_local_`, `_site_`, `_global_` 같은 값 들을 이용할 수도 있다.

network.host 의 값들에 대해서는 아래 페이지를 참고한다.

https://www.elastic.co/guide/en/elasticsearch/reference/7.1/modules-network.html#network-interface-values

설정파일에서 network.host: <EC2 private ip(내가입력해야함)> 와 같이 수정해준다.


```console
[ec2-user@ip-10-10-1-146 ~]$ sudo vim /etc/elasticsearch/elasticsearch.yml

################################################################################
# 원본파일 내용
################################################################################

# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
cluster.name: es-demo
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
node.name: ${HOSTNAME}
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
#bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
#
#network.host: 192.168.0.1
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true

################################################################################



################################################################################
# 수정후 내용
################################################################################

# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
cluster.name: es-demo
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
node.name: ${HOSTNAME}
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
#bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
# ex) network.host: 10.10.1.146
network.host: {이 서버의 EC2 private ip}
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true

################################################################################
```

3) Bootstrap Check

기본적으로 아래 문서에 나와있는 설정들은 모두 확인 하도록 한다.

https://www.elastic.co/guide/en/elasticsearch/reference/7.1/important-settings.html

그래서 bootstrap.memory_lock 활성하려고 한다.

elasticsearch.yml 설정 파일에서 bootstrap.memory_lock 을 활성화 한다.


```console
[ec2-user@ip-10-10-1-146 ~]$ sudo vim /etc/elasticsearch/elasticsearch.yml

################################################################################
# 원본파일 내용
################################################################################

# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
cluster.name: es-demo
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
node.name: ${HOSTNAME}
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
#bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
# ex) network.host: 10.10.1.146
network.host: {이 서버의 EC2 private ip}
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true

################################################################################



################################################################################
# 수정후 내용
################################################################################

# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
cluster.name: es-demo
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
node.name: ${HOSTNAME}
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
# ex) network.host: 10.10.1.146
network.host: {이 서버의 EC2 private ip}
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true

################################################################################

# 설정 후 elasticsearch를 재시작하면 실행에 실패할수도 있다.
[ec2-user@ip-10-10-1-146 ~]$ sudo systemctl restart elasticsearch.service
Job for elasticsearch.service failed because the control process exited with error code. See "systemctl status elasticsearch.service" and "journalctl -xe" for details.

# 시스템 로그를 보면 친절하게 어떻게 설정을 해 줘야 하는지 안내하고 있으니 아래와 같이 해준다.
# 먼저 아래와 같이 로그를 확인해보자
[ec2-user@ip-10-10-1-146 ~]$ systemctl status elasticsearch.service
● elasticsearch.service - Elasticsearch
   Loaded: loaded (/usr/lib/systemd/system/elasticsearch.service; enabled; vendor preset: disabled)
   Active: failed (Result: exit-code) since Sat 2021-08-28 14:35:23 KST; 23s ago
     Docs: https://www.elastic.co
  Process: 5844 ExecStart=/usr/share/elasticsearch/bin/systemd-entrypoint -p ${PID_DIR}/elasticsearch.pid --quiet (code=exited, status=78)
 Main PID: 5844 (code=exited, status=78)

Aug 28 14:35:08 es-coordinater systemd[1]: Starting Elasticsearch...
Aug 28 14:35:23 es-coordinater systemd-entrypoint[6273]: ERROR: [1] bootstrap checks failed. You must address the points described in the following [1] lines before starting Elasticsearch.
Aug 28 14:35:23 es-coordinater systemd-entrypoint[6273]: bootstrap check failure [1] of [1]: the default discovery settings are unsuitable for production use; at least one of [discovery.seed_hosts, discovery.seed_providers, cluster.initial_master_nodes] must be configured
Aug 28 14:35:23 es-coordinater systemd-entrypoint[6273]: ERROR: Elasticsearch did not exit normally - check the logs at /var/log/elasticsearch/es-demo.log
Aug 28 14:35:23 es-coordinater systemd[1]: elasticsearch.service: main process exited, code=exited, status=78/n/a
Aug 28 14:35:23 es-coordinater systemd[1]: Failed to start Elasticsearch.
Aug 28 14:35:23 es-coordinater systemd[1]: Unit elasticsearch.service entered failed state.
Aug 28 14:35:23 es-coordinater systemd[1]: elasticsearch.service failed.
Hint: Some lines were ellipsized, use -l to show in full.

[ec2-user@ip-10-10-1-146 ~]$ journalctl -xe
-- Unit elasticsearch.service has begun starting up.
Aug 28 14:35:23 es-coordinater systemd-entrypoint[5844]: ERROR: [1] bootstrap checks failed. You must address the points described in the following [1] lines before starting Elasticsearch.
Aug 28 14:35:23 es-coordinater systemd-entrypoint[5844]: bootstrap check failure [1] of [1]: the default discovery settings are unsuitable for production use; at least one of [discovery.seed_
Aug 28 14:35:23 es-coordinater systemd-entrypoint[5844]: ERROR: Elasticsearch did not exit normally - check the logs at /var/log/elasticsearch/es-demo.log
Aug 28 14:35:23 es-coordinater systemd[1]: elasticsearch.service: main process exited, code=exited, status=78/n/a
Aug 28 14:35:23 es-coordinater systemd[1]: Failed to start Elasticsearch.
-- Subject: Unit elasticsearch.service has failed
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
--
-- Unit elasticsearch.service has failed.
--
-- The result is failed.
Aug 28 14:35:23 es-coordinater systemd[1]: Unit elasticsearch.service entered failed state.
Aug 28 14:35:23 es-coordinater systemd[1]: elasticsearch.service failed.
Aug 28 14:35:23 es-coordinater sudo[5840]: pam_unix(sudo:session): session closed for user root
Aug 28 14:36:39 es-coordinater dhclient[2281]: XMT: Solicit on eth0, interval 130020ms.
Aug 28 14:38:49 es-coordinater dhclient[2281]: XMT: Solicit on eth0, interval 108960ms.
Aug 28 14:40:01 es-coordinater systemd[1]: Created slice User Slice of root.
-- Subject: Unit user-0.slice has finished start-up
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
--
-- Unit user-0.slice has finished starting up.
--
-- The start-up result is done.
Aug 28 14:40:01 es-coordinater systemd[1]: Started Session 17 of user root.
-- Subject: Unit session-17.scope has finished start-up
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
--
-- Unit session-17.scope has finished starting up.
--
-- The start-up result is done.
Aug 28 14:40:01 es-master CROND[6089]: (root) CMD (/usr/lib64/sa/sa1 1 1)
Aug 28 14:40:01 es-master systemd[1]: Removed slice User Slice of root.
-- Subject: Unit user-0.slice has finished shutting down
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
--
-- Unit user-0.slice has finished shutting down.
Aug 28 14:40:38 es-coordinater dhclient[2281]: XMT: Solicit on eth0, interval 117910ms.
Aug 28 14:41:35 es-coordinater sudo[6096]: ec2-user : TTY=pts/0 ; PWD=/home/ec2-user ; USER=root ; COMMAND=/bin/vim /etc/elasticsearch/elasticsearch.yml
Aug 28 14:41:35 es-coordinater sudo[6096]: pam_unix(sudo:session): session opened for user root by ec2-user(uid=0)
Aug 28 14:42:36 es-coordinater dhclient[2281]: XMT: Solicit on eth0, interval 129720ms.
Aug 28 14:44:12 es-coordinater sudo[6096]: pam_unix(sudo:session): session closed for user root
```

에러메세지의 핵심은 아래와 같다.

`at least one of [discovery.seed_hosts, discovery.seed_providers, cluster.initial_master_nodes] must be configured`

5) Unicast 설정

그래서 위의 가이드에 따라 `cluster.initial_master_nodes` 설정값을 추가해주고 다시 시작하면 잘 될 것이다.

그래서 노드끼리 통신할 수 있도록 노드의 ip 주소로 입력해주는 Unicast 설정을 해주려고 한다.

나중에는 Data node의 ip도 추가되어야하며 Data node들의 yml 파일에도 똑같이 적용되어야 한다. 

네트워크 주소는 `ifconfig` 또는 `ip addr` 명령으로 확인한다.

그래서 아래와 같이 컨피그 값을 변경해준다.

`discovery.seed_hosts: [All nodes private ip]` --> 이거는 데이터 노드를 생성후에 추가해주면 됨

`cluster.initial_master_nodes: ["es-coordinater"]`


```console
[ec2-user@ip-10-10-1-146 ~]$ sudo vim /etc/elasticsearch/elasticsearch.yml

################################################################################
# 원본파일 내용
################################################################################

# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
cluster.name: es-demo
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
node.name: ${HOSTNAME}
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
#
#network.host: 192.168.0.1
network.host: {이 서버의 EC2 private ip}
# ex) network.host: 10.10.1.146
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true

################################################################################


################################################################################
# 수정후 내용
################################################################################

# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
cluster.name: es-demo
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
node.name: ${HOSTNAME}
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
#
#network.host: 192.168.0.1
network.host: {이 서버의 EC2 private ip}
# ex) network.host: 10.10.1.146
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
# ex) discovery.seed_hosts: ["10.10.1.173"]
# 이후에 데이터 노드들이 추가 되면 여기도 추가된 노드를 써줘야 한다.
discovery.seed_hosts: ["{이 서버의 EC2 private ip}"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
# 이니셜하게 마스터노드를 어떤거를 잡아줄거냐를 지정하는 부분이다.
# 아래와 같이 일단은 코디네이터 노드의 호스트네임을 넣어주면된다.
cluster.initial_master_nodes: ["es-coordinater"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true

################################################################################

[ec2-user@ip-10-10-1-146 ~]$ sudo systemctl restart elasticsearch.service

[ec2-user@ip-10-10-1-146 ~]$ sudo systemctl status elasticsearch.service
● elasticsearch.service - Elasticsearch
   Loaded: loaded (/usr/lib/systemd/system/elasticsearch.service; enabled; vendor preset: disabled)
   Active: active (running) since Sat 2021-08-28 14:48:05 KST; 26s ago
     Docs: https://www.elastic.co
 Main PID: 6124 (java)
   CGroup: /system.slice/elasticsearch.service
           ├─6124 /usr/share/elasticsearch/jdk/bin/java -Xshare:auto -Des.networkaddress.cache.ttl=60 -Des.networkaddress.cache.negative.ttl=10 -XX:+AlwaysPreTouch -Xss1m -Djava.awt.h...
           └─6325 /usr/share/elasticsearch/modules/x-pack-ml/platform/linux-x86_64/bin/controller

Aug 28 14:47:51 es-coordinater systemd[1]: Starting Elasticsearch...
Aug 28 14:48:05 es-coordinater systemd[1]: Started Elasticsearch.

[ec2-user@ip-10-10-1-146 ~]$ curl es-coordinater:9200
{
  "name" : "es-coordinater",
  "cluster_name" : "es-demo",
  "cluster_uuid" : "dFOYiQ7RRGiurpSiIdPaPQ",
  "version" : {
    "number" : "7.14.0",
    "build_flavor" : "default",
    "build_type" : "rpm",
    "build_hash" : "dd5a0a2acaa2045ff9624f3729fc8a6f40835aa1",
    "build_date" : "2021-07-29T20:49:32.864135063Z",
    "build_snapshot" : false,
    "lucene_version" : "8.9.0",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}
```

** Split Brain 문제

일반적으로 노드가 10개 내의 클러스터는 마스터 노드를 따로 구분하지 않고 데이터 노드 중 임의의 노드가 마스터 역할을 병행해서 수행하도록 해도 큰 문제는 없다. 10개 이상의 노드로 구성된 클러스터인 경우 마스터 전용 노드와 데이터 전용 노드를 분리하는 것이 좋으며, 이 때 마스터 기능의 수행이 가능한 후보(master-eligible) 노드를 3(또는 그 이상의 홀수)개를 두어 실제 마스터 노드가 다운된 경우 다른 노드가 그 역할을 대신 할 수 있도록 설정하는 것이 일반적이다. 2개만 두는 경우에는 네트워크 단절로 인한 클러스터 분리 문제 (quorum)로 인해 하나의 클러스터가 서로 다른 마스터를 가진 2개의 클러스터로 나누어 져서 나중에 동기화 문제가 생길 수 있다. 이를 Split Brain 이라고 한다.

마스터 후보 노드를 3개(또는 그 이상의 홀수)로 두는 경우에는 네트워크 단절로 인해 클러스터가 분리가 되면 마스터 후보가 2개인 클러스터만 실제로 동작하고 1개인 클러스터는 동작을 멈추게 된다. 그렇게 해서 다시 네트워크가 복구 되었을 때 활성 상태였던 클러스터 노드들의 업데이트 정보가 비활성 상태였던 클러스터 노드들로 자연스럽게 동기화가 될 수 있다.

6) X-Pack 설치

X-Pack은 보안, 경고, 모니터링,보고, 기계 학습 및 기타 여러 기능을 제공하는 Elastic Stack 확장팩이다. 기본적으로 Elasticsearch를 설치하면 X-Pack이 설치된다.

모든 X-Pack 기능을 사용해 보려면 30 일 평가판을 시작할 수 있다. 평가 기간이 끝나면 구독을 구매하여 X-Pack 구성 요소의 전체 기능을 계속 사용할 수 있다. 자세한 내용은 https://www.elastic.co/subscriptions를 참조한다.

먼저 아래와 같이 x-pack을 설치해준다.


```console
[ec2-user@ip-10-10-1-146 ~]$ cd /usr/share/elasticsearch

[ec2-user@ip-10-10-1-146 elasticsearch]$ sudo bin/elasticsearch-plugin install x-pack
-> Installing x-pack
-> Failed installing x-pack
ERROR: this distribution of Elasticsearch contains X-Pack by default
```

설치하려고 하니까 이미 깔려있다고 설치가 안된다. 그러면 다음으로 넘어가자

6.8 / 7.1 버전은 security 가 basic 라이선스로도 사용가능하다.

링크 참고 : https://www.elastic.co/kr/blog/security-for-elasticsearch-is-now-free

X-pack 활성화 등 보안설정은 뒤로 미루고 일단은 아래와 같이 암호설정을 먼저 해준다. 

(elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user)

암호설정을 하기 위해서는 먼저 x-pack 활성화가 되어야 하기 때문에 elasticsearch.yml에 아래의 컨피그를 추가한다.

`xpack.security.transport.ssl.enabled: true`

`xpack.security.enabled: true`

그런 다음에 `./elasticsearch-setup-passwords interactive` 명령어로 아래와 같이 비번을 생성해준다.


```console
[ec2-user@ip-10-10-1-146 ~]$ curl -X GET "es-coordinater:9200/_xpack/license/trial_status"
{"eligible_to_start_trial":true}

[ec2-user@ip-10-10-1-146 ~]$ curl -X POST "es-coordinater:9200/_xpack/license/start_trial?acknowledge=true"
{"acknowledged":true,
 "trial_was_started":true,
 "type":"trial"
}

[ec2-user@ip-10-10-1-146 ~]$ curl -X GET "es-coordinater:9200/_license"
{
  "license" : {
    "status" : "active",
    "uid" : "c4d1dbc4-24a3-41af-9177-6a9c59948584",
    "type" : "trial",
    "issue_date" : "2021-08-29T04:55:56.818Z",
    "issue_date_in_millis" : 1630212956818,
    "expiry_date" : "2021-09-28T04:55:56.818Z",
    "expiry_date_in_millis" : 1632804956818,
    "max_nodes" : 1000,
    "issued_to" : "es-demo",
    "issuer" : "elasticsearch",
    "start_date_in_millis" : -1
  }
}

[ec2-user@ip-10-10-1-146 ~]$ cd /usr/share/elasticsearch/bin/

[ec2-user@ip-10-10-1-146 bin]$ ll
total 35216
-rwxr-xr-x 1 root root     2896 Jul 30 06:01 elasticsearch
-rwxr-xr-x 1 root root      501 Jul 30 05:51 elasticsearch-certgen
-rwxr-xr-x 1 root root      493 Jul 30 05:51 elasticsearch-certutil
-rwxr-xr-x 1 root root      996 Jul 30 06:01 elasticsearch-cli
-rwxr-xr-x 1 root root      443 Jul 30 05:51 elasticsearch-croneval
-rwxr-xr-x 1 root root     4825 Jul 30 06:01 elasticsearch-env
-rwxr-xr-x 1 root root     1828 Jul 30 06:01 elasticsearch-env-from-file
-rwxr-xr-x 1 root root      168 Jul 30 06:01 elasticsearch-geoip
-rwxr-xr-x 1 root root      184 Jul 30 06:01 elasticsearch-keystore
-rwxr-xr-x 1 root root      450 Jul 30 05:51 elasticsearch-migrate
-rwxr-xr-x 1 root root      126 Jul 30 06:01 elasticsearch-node
-rwxr-xr-x 1 root root      172 Jul 30 06:01 elasticsearch-plugin
-rwxr-xr-x 1 root root      441 Jul 30 05:51 elasticsearch-saml-metadata
-rwxr-xr-x 1 root root      439 Jul 30 05:51 elasticsearch-service-tokens
-rwxr-xr-x 1 root root      448 Jul 30 05:51 elasticsearch-setup-passwords
-rwxr-xr-x 1 root root      118 Jul 30 06:01 elasticsearch-shard
-rwxr-xr-x 1 root root      483 Jul 30 05:51 elasticsearch-sql-cli
-rwxr-xr-x 1 root root 35959661 Jul 30 05:51 elasticsearch-sql-cli-7.14.0.jar
-rwxr-xr-x 1 root root      436 Jul 30 05:51 elasticsearch-syskeygen
-rwxr-xr-x 1 root root      436 Jul 30 05:51 elasticsearch-users
-rwxr-xr-x 1 root root      332 Jul 30 05:58 systemd-entrypoint
-rwxr-xr-x 1 root root      356 Jul 30 05:50 x-pack-env
-rwxr-xr-x 1 root root      364 Jul 30 05:51 x-pack-security-env
-rwxr-xr-x 1 root root      363 Jul 30 05:51 x-pack-watcher-env

# keystore 리스트 조회한다 
[ec2-user@ip-10-10-1-146 bin]$ sudo ./elasticsearch-keystore list
keystore.seed

# 참고로 만약에 위와 같이 keystore를 조회했는데 없으면 아래와 같이 생성해주면 된다.
# $ cd /usr/share/elasticsearch/bin/ 
# $ sudo ./elasticsearch-keystore create 
# 그러면 /etc/elasticsearch/elasticsearch.keystore 파일이 생성된다



[ec2-user@ip-10-10-1-146 ~]$ cd /usr/share/elasticsearch

[ec2-user@ip-10-10-1-146 elasticsearch]$ sudo vim /etc/elasticsearch/elasticsearch.yml

################################################################################
# 원본파일 내용
################################################################################

# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
cluster.name: es-demo
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
node.name: ${HOSTNAME}
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
#
#network.host: 192.168.0.1
network.host: {이 서버의 EC2 private ip}
# ex) network.host: 10.10.1.146
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
# ex) discovery.seed_hosts: ["10.10.1.173"]
discovery.seed_hosts: ["{이 서버의 EC2 private ip}"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
cluster.initial_master_nodes: ["es-coordinater"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true

################################################################################



################################################################################
# 수정후 내용
################################################################################

# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
cluster.name: es-demo
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
node.name: ${HOSTNAME}
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
#
#network.host: 192.168.0.1
network.host: {이 서버의 EC2 private ip}
# ex) network.host: 10.10.1.146
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
# ex) discovery.seed_hosts: ["10.10.1.173"]
discovery.seed_hosts: ["{이 서버의 EC2 private ip}"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
cluster.initial_master_nodes: ["es-coordinater"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true

xpack.security.transport.ssl.enabled: true
xpack.security.enabled: true

# Enable auditing to keep track of attempted
# and successful interactions with Elasticsearch cluster
# events are logged to a dedicated elasticsearch-access.log file
xpack.security.audit.enabled: true

################################################################################

[ec2-user@ip-10-10-1-146 elasticsearch]$ sudo systemctl restart elasticsearch.service

[ec2-user@ip-10-10-1-146 elasticsearch]$ sudo systemctl status elasticsearch.service
● elasticsearch.service - Elasticsearch
   Loaded: loaded (/usr/lib/systemd/system/elasticsearch.service; enabled; vendor preset: disabled)
   Active: active (running) since Sat 2021-08-28 14:54:05 KST; 6s ago
     Docs: https://www.elastic.co
 Main PID: 9088 (java)
   CGroup: /system.slice/elasticsearch.service
           ├─9088 /usr/share/elasticsearch/jdk/bin/java -Xshare:auto -Des.networkaddress.cache.ttl=60 -Des.networkaddress.cache.negative.ttl=10 -XX:+AlwaysPreTouch -Xss1m -Djava.awt.headless=true -Dfile.e...
           └─9290 /usr/share/elasticsearch/modules/x-pack-ml/platform/linux-x86_64/bin/controller

Aug 28 20:19:33 es-coordinater systemd[1]: Starting Elasticsearch...
Aug 28 20:19:48 es-coordinater systemd[1]: Started Elasticsearch.


[ec2-user@ip-10-10-1-146 elasticsearch]$ cd /usr/share/elasticsearch/bin

[ec2-user@ip-10-10-1-146 bin]$ sudo ./elasticsearch-setup-passwords interactive
Initiating the setup of passwords for reserved users elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user.
You will be prompted to enter passwords as the process progresses.
Please confirm that you would like to continue [y/N]y


Enter password for [elastic]: mypw3#
Reenter password for [elastic]: mypw3#
Enter password for [apm_system]: mypw3#
Reenter password for [apm_system]: mypw3#
Enter password for [kibana_system]: mypw3#
Reenter password for [kibana_system]: mypw3#
Enter password for [logstash_system]: mypw3#
Reenter password for [logstash_system]: mypw3#
Enter password for [beats_system]: mypw3#
Reenter password for [beats_system]: mypw3#
Enter password for [remote_monitoring_user]: mypw3#
Reenter password for [remote_monitoring_user]: mypw3#
Changed password for user [apm_system]
Changed password for user [kibana_system]
Changed password for user [kibana]
Changed password for user [logstash_system]
Changed password for user [beats_system]
Changed password for user [remote_monitoring_user]
Changed password for user [elastic]

[ec2-user@ip-10-10-1-146 ~]$ cd ~

[ec2-user@ip-10-10-1-146 bin]$ curl http://es-coordinater:9200 -k -u elastic
Enter host password for user 'elastic':
{
  "name" : "es-coordinater",
  "cluster_name" : "es-demo",
  "cluster_uuid" : "izaZHPF9Q5K9xeDpI3gRLQ",
  "version" : {
    "number" : "7.14.0",
    "build_flavor" : "default",
    "build_type" : "rpm",
    "build_hash" : "dd5a0a2acaa2045ff9624f3729fc8a6f40835aa1",
    "build_date" : "2021-07-29T20:49:32.864135063Z",
    "build_snapshot" : false,
    "lucene_version" : "8.9.0",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}

# 또는 아래 curl 명령어도 같은거임
[ec2-user@ip-10-10-1-146 bin]$ curl http://10.10.1.221:9200 -k -u elastic
Enter host password for user 'elastic':
{
  "name" : "es-coordinater",
  "cluster_name" : "es-demo",
  "cluster_uuid" : "izaZHPF9Q5K9xeDpI3gRLQ",
  "version" : {
    "number" : "7.14.0",
    "build_flavor" : "default",
    "build_type" : "rpm",
    "build_hash" : "dd5a0a2acaa2045ff9624f3729fc8a6f40835aa1",
    "build_date" : "2021-07-29T20:49:32.864135063Z",
    "build_snapshot" : false,
    "lucene_version" : "8.9.0",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}
```

** SSL/TLS

X-Pack Security는 노드간, 그리고 클러스터와 클라이언트 간의 통신을 암호화 하는 SSL/TLS 기능을 가지고 있다. 특히 elasticsearch 6.0 부터는 X-Pack Security를 사용하기 위해서는 SSL/TLS 설정을 반드시 활성화 해야 오류나 경고 메시지가 나타나지 않는다.

- STEP 3) 클러스터 구성 및 마스터, 데이터 노드 설정

1) 데이터 노드 추가

4개 서버로 구성된 클러스터를 만들기 위해서는 앞의 내용대로 서버를 하나씩 만드는 방법도 있겠지만, AWS 에는 서버의 이미지 스냅샷을 이용해서 이미지를 뜨고 그거를 생성하면 된다.

위에서 EC2를 stop하고 아래 그림과 같이 이미지를 뜬다.

아래에 그림에는 `pms-es-master-test`라고 되어 있는데 `pms-es-coordinater-test`로 이름을 정해준다.

![2](https://user-images.githubusercontent.com/41605276/131209796-9d9a3d98-61c5-440e-926d-8ddeeed8b80f.png)

그런 다음에 위에 이미지 뜬거를 갖고 아래와 같이 EC2를 생성해준다.

마스터 1, 데이터 노드 3 으로 생성하면 되는데 생성할때 데이터 노드 보안그룹 위에서 만든거를 적용을 해서 만들어준다.

![4](https://user-images.githubusercontent.com/41605276/131216727-6bb78869-7c2c-4b94-bb3a-5ebd13fa223c.png)

그리고 코디네이트 노드에 접속해서 es를 stop하고 아래와 같이 명령어를 실행해준다.


```console
# 서비스 중지
[ec2-user@es-coordinater ~]$ sudo service elasticsearch stop
Stopping elasticsearch (via systemctl):                    [  OK  ]

# 데이터 디렉토리 삭제
[ec2-user@es-coordinater ~]$ sudo rm -rf /var/lib/elasticsearch/nodes

[ec2-user@es-coordinater ~]$ sudo vim /etc/sysconfig/network
NETWORKING=yes
NOZEROCONF=yes
HOSTNAME=es-coordinater


[ec2-user@es-coordinater ~]$ sudo vim /etc/elasticsearch/elasticsearch.yml


################################################################################
# 수정후 내용
################################################################################


# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
cluster.name: es-demo
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
node.name: ${HOSTNAME}
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
#
#network.host: 192.168.0.1
network.host: {이 서버의 EC2 private ip}
# ex) network.host: 10.10.1.146
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
# ex) discovery.seed_hosts: ["10.10.1.173"]
discovery.seed_hosts: ["{이 서버의 EC2 private ip}"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
cluster.initial_master_nodes: ["es-coordinater"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true
#
xpack.security.transport.ssl.enabled: true
xpack.security.enabled: true

################################################################################




################################################################################
# 수정후 내용
################################################################################


# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
cluster.name: es-demo
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
node.name: ${HOSTNAME}
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
#
#network.host: 192.168.0.1
network.host: {이 서버의 EC2 private ip}
# ex) network.host: 10.10.1.96
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
# ex) discovery.seed_hosts: ["10.10.1.173","10.10.1.83","10.10.1.146","10.10.1.249"]
# !!!! 모든 노드 아이피 추가해야함 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
discovery.seed_hosts: ["코디네이트 노드 프라이빗 아이피","데이터노드 01 프라이빗 아이피","데이터노드 02 프라이빗 아이피","데이터노드 03 프라이빗 아이피"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
cluster.initial_master_nodes: ["data01","data02","data03"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true
#
xpack.security.transport.ssl.enabled: true
xpack.security.enabled: true

# Enable auditing to keep track of attempted
# and successful interactions with Elasticsearch cluster
# events are logged to a dedicated elasticsearch-access.log file
xpack.security.audit.enabled: true

node.master: false
node.data: false

################################################################################
```

데이터 노드도 각각 접속해서 아래와 같이 설정해준다.


```console
# 서비스 중지
[ec2-user@ip-10-10-1-96 ~]$ sudo service elasticsearch stop
Stopping elasticsearch (via systemctl):                    [  OK  ]

# 데이터 디렉토리 삭제
[ec2-user@ip-10-10-1-96 ~]$ sudo rm -rf /var/lib/elasticsearch/nodes

# 호스트 네임 변경
# 노드 이름이 호스트명으로 할당되도록 설정되어 있으므로, 각 데이터 노드들의 호스트명을 해당 노드에 맞게 바꿔준다
# 노드 이름에 따라 아래와 같이 data01, data02, data03 으로 각각 설정해주면 된다.
[ec2-user@ip-10-10-1-96 ~]$ sudo hostnamectl set-hostname data01

[ec2-user@ip-10-10-1-96 ~]$ hostname
data01

[ec2-user@ip-10-10-1-224 ~]$ sudo vim /etc/sysconfig/network
NETWORKING=yes
NOZEROCONF=yes
HOSTNAME=data01

[ec2-user@ip-10-10-1-96 ~]$ sudo vim /etc/elasticsearch/elasticsearch.yml


################################################################################
# 원본 내용
################################################################################


# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
cluster.name: es-demo
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
node.name: ${HOSTNAME}
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
#
#network.host: 192.168.0.1
network.host: {이 서버의 EC2 private ip}
# ex) network.host: 10.10.1.146
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
# ex) discovery.seed_hosts: ["10.10.1.173"]
discovery.seed_hosts: ["{이 서버의 EC2 private ip}"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
cluster.initial_master_nodes: ["es-coordinater"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true
#
xpack.security.transport.ssl.enabled: true
xpack.security.enabled: true

################################################################################




################################################################################
# 수정후 내용
################################################################################


# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
cluster.name: es-demo
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
node.name: ${HOSTNAME}
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
#
#network.host: 192.168.0.1
network.host: {이 서버의 EC2 private ip}
# ex) network.host: 10.10.1.224
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
# ex) discovery.seed_hosts: ["10.10.1.173","10.10.1.83","10.10.1.146","10.10.1.249"]
# !!!! 마스터노드, 데이터 노드 모든 노드 아이피 추가해야함 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
discovery.seed_hosts: ["코디네이트 노드 프라이빗 아이피","데이터노드 01 프라이빗 아이피","데이터노드 02 프라이빗 아이피","데이터노드 03 프라이빗 아이피"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
cluster.initial_master_nodes: ["data01","data02","data03"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true
#
xpack.security.transport.ssl.enabled: true
xpack.security.enabled: true

# Enable auditing to keep track of attempted
# and successful interactions with Elasticsearch cluster
# events are logged to a dedicated elasticsearch-access.log file
xpack.security.audit.enabled: true

node.master: true
node.data: true

################################################################################
```

각각의 노드별로 위와 같이 설정했다면 아래와 같이 일괄 재부팅을 해준다.

![5](https://user-images.githubusercontent.com/41605276/131210979-243e9a89-f6ba-4629-8a5c-46aa3ede7217.png)

X-Pack은 위에서 이미 설치가 되어 있으니 이제 인증서 파일을 만들어 준다. 공인 인증기관으로부터 구매한 인증서가 있다면 사용해도 되고, X-Pack 에는 Elastic 에서 발행하는 사설 인증서를 생성하는 도구인 certgen 을 포함하고 있다. 

certgen에 대한 내용은 아래 링크를 참고한다.

https://www.elastic.co/guide/en/elasticsearch/reference/7.x/certgen.html

인증서를 생성하기 위해 코디네이트 노드로 가서 다음과 같은 명령을 실행한다.


```console
[ec2-user@es-coordinater bin]$ cd /usr/share/elasticsearch/

[ec2-user@es-coordinater elasticsearch]$ sudo bin/elasticsearch-certgen
******************************************************************************
Note: The 'elasticsearch-certgen' tool has been deprecated in favour of the
      'elasticsearch-certutil' tool. This command will be removed in a future
      release.
******************************************************************************

This tool assists you in the generation of X.509 certificates and certificate
signing requests for use with SSL in the Elastic stack. Depending on the command
line option specified, you may be prompted for the following:

* The path to the output file
    * The output file is a zip file containing the signed certificates and
      private keys for each instance. If a Certificate Authority was generated,
      the certificate and private key will also be included in the output file.
* Information about each instance
    * An instance is any piece of the Elastic Stack that requires an SSL certificate.
      Depending on your configuration, Elasticsearch, Logstash, Kibana, and Beats
      may all require a certificate and private key.
    * The minimum required value for each instance is a name. This can simply be the
      hostname, which will be used as the Common Name of the certificate. A full
      distinguished name may also be used.
    * A filename value may be required for each instance. This is necessary when the
      name would result in an invalid file or directory name. The name provided here
      is used as the directory name (within the zip) and the prefix for the key and
      certificate files. The filename is required if you are prompted and the name
      is not displayed in the prompt.
    * IP addresses and DNS names are optional. Multiple values can be specified as a
      comma separated string. If no IP addresses or DNS names are provided, you may
      disable hostname verification in your SSL configuration.
* Certificate Authority private key password
    * The password may be left empty if desired.

Let's get started...

Please enter the desired output file [certificate-bundle.zip]: 그냥엔터
Enter instance name: es-demo  --> 이거는 맘대로 지어도 됨
Enter name for directories and files [es-demo]: 그냥엔터
Enter IP Addresses for instance (comma-separated if more than one) []: 10.10.1.173,10.10.1.83,10.10.1.146,10.10.1.249 --> 모든 노드들의 프라이빗 아이피
Enter DNS names for instance (comma-separated if more than one) []: 그냥 엔터
Would you like to specify another instance? Press 'y' to continue entering instance information: n
Certificates written to /usr/share/elasticsearch/certificate-bundle.zip

This file should be properly secured as it contains the private keys for all
instances and the certificate authority.

After unzipping the file, there will be a directory for each instance containing
the certificate and private key. Copy the certificate, key, and CA certificate
to the configuration directory of the Elastic product that they will be used for
and follow the SSL configuration instructions in the product guide.

For client applications, you may only need to copy the CA certificate and
configure the client to trust this certificate.

[ec2-user@es-coordinater elasticsearch]$ sudo mkdir /etc/elasticsearch/config

[ec2-user@es-coordinater elasticsearch]$ sudo mv certificate-bundle.zip /etc/elasticsearch/config

[ec2-user@es-coordinater elasticsearch]$ cd ~

[ec2-user@es-coordinater ~]$ sudo su

[root@es-coordinater ec2-user]# cd /etc/elasticsearch/config/

[root@es-coordinater config]# ll
total 8
-rw------- 1 ec2-user ec2-user 5087 Aug 28 21:26 certificate-bundle.zip

[root@es-coordinater config]# unzip certificate-bundle.zip
Archive:  certificate-bundle.zip
   creating: ca/
  inflating: ca/ca.crt
  inflating: ca/ca.key
   creating: es-demo/
  inflating: es-demo/es-demo.crt
  inflating: es-demo/es-demo.key
    
[root@es-coordinater config]# ll
total 8
drwxr-sr-x 2 root     elasticsearch   34 Aug 28 21:03 ca
-rw------- 1 ec2-user ec2-user      5087 Aug 28 21:26 certificate-bundle.zip
drwxr-sr-x 2 root     elasticsearch   44 Aug 28 21:03 es-demo
    
[root@es-coordinater config]# exit
exit
    
[ec2-user@es-coordinater etc]$ cd ~

# 여기 경로에 ec2에 접속하는 key를 업로드를 해준다.
[ec2-user@es-coordinater ~]$ ll
total 4
-rw------- 1 ec2-user ec2-user 1696 Aug 28 21:10 pms-seoul-key.pem
    
[ec2-user@es-coordinater ~]$ sudo chmod 600 pms-seoul-key.pem

#scp 명령어를 이용해서 마스터 노드의 인증서를 각각의 데이터 노드로 보내준다.
[ec2-user@es-coordinater ~]$ sudo scp -i /home/ec2-user/pms-seoul-key.pem /etc/elasticsearch/config/certificate-bundle.zip ec2-user@10.10.1.83:/home/ec2-user/certificate-bundle.zip
The authenticity of host '10.10.1.83 (10.10.1.83)' can't be established.
ECDSA key fingerprint is SHA256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.
ECDSA key fingerprint is xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '10.10.1.83' (ECDSA) to the list of known hosts.
certificate-bundle.zip    

[ec2-user@es-coordinater ~]$ sudo scp -i /home/ec2-user/pms-seoul-key.pem /etc/elasticsearch/config/certificate-bundle.zip ec2-user@10.10.1.146:/home/ec2-user/certificate-bundle.zip
The authenticity of host '10.10.1.146 (10.10.1.146)' can't be established.
ECDSA key fingerprint is SHA256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.
ECDSA key fingerprint is xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '10.10.1.146' (ECDSA) to the list of known hosts.
certificate-bundle.zip                                                                                                        100% 5087     5.2MB/s   00:00

[ec2-user@es-coordinater ~]$ sudo scp -i /home/ec2-user/pms-seoul-key.pem /etc/elasticsearch/config/certificate-bundle.zip ec2-user@10.10.1.249:/home/ec2-user/certificate-bundle.zip
The authenticity of host '10.10.1.249 (10.10.1.249)' can't be established.
ECDSA key fingerprint is SHA256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.
ECDSA key fingerprint is xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '10.10.1.249' (ECDSA) to the list of known hosts.
certificate-bundle.zip      
```

각각의 모든 데이터 노드에 접속해서 아래와 같이 명령어를 실행해준다.


```console
[ec2-user@data01 ~]$ ll
total 8
-rw------- 1 ec2-user ec2-user 5087 Aug 28 21:26 certificate-bundle.zip

[ec2-user@data01 ~]$ sudo mkdir /etc/elasticsearch/config

[ec2-user@data01 ~]$ sudo mv certificate-bundle.zip /etc/elasticsearch/config

[ec2-user@data01 ~]$ sudo su

[root@data01 ec2-user]# cd /etc/elasticsearch/config/

[root@data01 config]# ll
total 8
-rw------- 1 ec2-user ec2-user 5087 Aug 28 21:26 certificate-bundle.zip

[root@data01 config]# unzip certificate-bundle.zip
Archive:  certificate-bundle.zip
   creating: ca/
  inflating: ca/ca.crt
  inflating: ca/ca.key
   creating: es-demo/
  inflating: es-demo/es-demo.crt
  inflating: es-demo/es-demo.key
    
[root@data01 config]# ll
total 8
drwxr-sr-x 2 root     elasticsearch   34 Aug 28 21:03 ca
-rw------- 1 ec2-user ec2-user      5087 Aug 28 21:26 certificate-bundle.zip
drwxr-sr-x 2 root     elasticsearch   44 Aug 28 21:03 es-demo
```

이제 인증서가 만들어 졌으니 elasticsearch 설정을 한다.

설정은 아래 페이지를 참고하여 진행한다.

https://www.elastic.co/guide/en/x-pack/current/ssl-tls.html#enable-ssl

아래의 명령어는 코디네이트에서 실행한 명령이지만 다른 모든 노드에 들어가서도 아래와 같이 해준다.


```console
[ec2-user@es-coordinater ~]$ sudo vim /etc/elasticsearch/elasticsearch.yml
# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
cluster.name: es-demo
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
node.name: ${HOSTNAME}
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /var/lib/elasticsearch
#
# Path to log files:
#
path.logs: /var/log/elasticsearch
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
#
#network.host: 192.168.0.1
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
# 각각의 노드에 따라서 프라이빗 아이피를 아래와 같이 잡아줘야 한다.
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
network.host: 10.10.1.173
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
discovery.seed_hosts: ["10.10.1.173","10.10.1.83","10.10.1.146","10.10.1.249"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
cluster.initial_master_nodes: ["data01","data02","data03"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Require explicit names when deleting indices:
#
#action.destructive_requires_name: true
#
xpack.security.transport.ssl.enabled: true
xpack.security.enabled: true

# Enable auditing to keep track of attempted
# and successful interactions with Elasticsearch cluster
# events are logged to a dedicated elasticsearch-access.log file
xpack.security.audit.enabled: true

xpack.security.transport.ssl.key: /etc/elasticsearch/config/es-demo/es-demo.key
xpack.security.transport.ssl.certificate: /etc/elasticsearch/config/es-demo/es-demo.crt
xpack.security.transport.ssl.certificate_authorities: [ "/etc/elasticsearch/config/ca/ca.crt" ]

# 코디네이트 노드일때
node.master: false
node.data: false

# 데이터노드일때는 아래와 같은지 잊지말고 체크해주자
# node.master: true
# node.data: true

[ec2-user@es-coordinater ~]$ sudo systemctl restart elasticsearch.service

[ec2-user@es-coordinater ~]$ sudo systemctl status elasticsearch.service
● elasticsearch.service - Elasticsearch
   Loaded: loaded (/usr/lib/systemd/system/elasticsearch.service; enabled; vendor preset: disabled)
   Active: active (running) since Sat 2021-08-28 22:02:59 KST; 15s ago
     Docs: https://www.elastic.co
 Main PID: 4136 (java)
   CGroup: /system.slice/elasticsearch.service
           ├─4136 /usr/share/elasticsearch/jdk/bin/java -Xshare:auto -Des.networkaddress.cache.ttl=60 -Des.networkaddress.cache.negative.ttl=10 -XX:+AlwaysPreTouch -Xss1m -Dja...
           └─4339 /usr/share/elasticsearch/modules/x-pack-ml/platform/linux-x86_64/bin/controller

Aug 28 22:02:44 es-coordinater systemd[1]: Starting Elasticsearch...
Aug 28 22:02:59 es-coordinater systemd[1]: Started Elasticsearch.
```

그런 다음에 코디네이트 노드에서 클러스터 노드들이 잘 구성이 되었는지 아래와 같이 명령어를 실행해서 체크해보자


```console
# 먼저 코디네이트 노드에서 비번을 재설정해주자.
# 이거를 안하고 elastic 계정으로 curl 명령을 날리면
# unable to authenticate user [elastic] for REST request 에러가 계속 발생하더라..

[ec2-user@es-coordinater ~]$ cd /usr/share/elasticsearch/bin

[ec2-user@es-coordinater bin]$ sudo ./elasticsearch-setup-passwords interactive
Initiating the setup of passwords for reserved users elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user.
You will be prompted to enter passwords as the process progresses.
Please confirm that you would like to continue [y/N]y


Enter password for [elastic]:
Reenter password for [elastic]:
Enter password for [apm_system]:
Reenter password for [apm_system]:
Enter password for [kibana_system]:
Reenter password for [kibana_system]:
Enter password for [logstash_system]:
Reenter password for [logstash_system]:
Enter password for [beats_system]:
Reenter password for [beats_system]:
Enter password for [remote_monitoring_user]:
Reenter password for [remote_monitoring_user]:
Changed password for user [apm_system]
Changed password for user [kibana_system]
Changed password for user [kibana]
Changed password for user [logstash_system]
Changed password for user [beats_system]
Changed password for user [remote_monitoring_user]
Changed password for user [elastic]

[ec2-user@es-coordinater ~]$ curl es-coordinater:9200/_cat/nodes?v -k -u elastic
Enter host password for user 'minman_admin':
ip         heap.percent ram.percent cpu load_1m load_5m load_15m node.role  master name
10.10.1.146           12          35   0    0.00    0.12     0.12 ilmr       -      es-coordinater
10.10.1.249           19          35   0    0.00    0.08     0.08 cdfhilrstw -      data01
10.10.1.173           17          32   0    0.00    0.10     0.06 cdfhilrstw -      data02
10.10.1.83            14          28   0    0.00    0.03     0.10 cdfhilrstw *      data03

# 아래와 같이 코디네이트 노드에서 그리고 데이터 노드중 일부 노드에 접속해서 elasticsearch 로그도 확인해서 문제가 없는지 체크해본다.
[ec2-user@es-coordinater bin]$ sudo su

[root@es-coordinater bin]# cd /var/log/elasticsearch/

[root@es-coordinater elasticsearch]# tail -100 es-demo.log
[2021-09-24T21:58:45,598][INFO ][o.e.x.w.WatcherService   ] [es-coordinater] stopping watch service, reason [shutdown initiated]
[2021-09-24T21:58:45,600][INFO ][o.e.x.m.p.l.CppLogMessageHandler] [es-coordinater] [controller/2932] [Main.cc@169] ML controller exiting
[2021-09-24T21:58:45,600][INFO ][o.e.x.m.p.NativeController] [es-coordinater] Native controller process has stopped - no new native processes can be started
[2021-09-24T21:58:45,601][INFO ][o.e.x.w.WatcherLifeCycleService] [es-coordinater] watcher has stopped and shutdown
[2021-09-24T21:58:45,611][INFO ][o.e.n.Node               ] [es-coordinater] stopped
[2021-09-24T21:58:45,611][INFO ][o.e.n.Node               ] [es-coordinater] closing ...
[2021-09-24T21:58:45,629][INFO ][o.e.n.Node               ] [es-coordinater] closed
[2021-09-24T21:58:50,391][INFO ][o.e.n.Node               ] [es-coordinater] version[7.14.1], pid[3165], build[default/rpm/66b55ebfa59c92c15db3f69a335d500018b3331e/2021-08-26T09:01:05.390870785Z], OS[Linux/4.14.243-185.433.amzn2.x86_64/amd64], JVM[Eclipse Foundation/OpenJDK 64-Bit Server VM/16.0.2/16.0.2+7]
[2021-09-24T21:58:50,394][INFO ][o.e.n.Node               ] [es-coordinater] JVM home [/usr/share/elasticsearch/jdk], using bundled JDK [true]
[2021-09-24T21:58:50,395][INFO ][o.e.n.Node               ] [es-coordinater] JVM arguments [-Xshare:auto, -Des.networkaddress.cache.ttl=60, -Des.networkaddress.cache.negative.ttl=10, -XX:+AlwaysPreTouch, -Xss1m, -Djava.awt.headless=true, -Dfile.encoding=UTF-8, -Djna.nosys=true, -XX:-OmitStackTraceInFastThrow, -XX:+ShowCodeDetailsInExceptionMessages, -Dio.netty.noUnsafe=true, -Dio.netty.noKeySetOptimization=true, -Dio.netty.recycler.maxCapacityPerThread=0, -Dio.netty.allocator.numDirectArenas=0, -Dlog4j.shutdownHookEnabled=false, -Dlog4j2.disable.jmx=true, -Djava.locale.providers=SPI,COMPAT, --add-opens=java.base/java.io=ALL-UNNAMED, -Xms4g, -Xmx4g, -XX:+UseG1GC, -Djava.io.tmpdir=/tmp/elasticsearch-1460899445039453400, -XX:+HeapDumpOnOutOfMemoryError, -XX:HeapDumpPath=/var/lib/elasticsearch, -XX:ErrorFile=/var/log/elasticsearch/hs_err_pid%p.log, -Xlog:gc*,gc+age=trace,safepoint:file=/var/log/elasticsearch/gc.log:utctime,pid,tags:filecount=32,filesize=64m, -XX:MaxDirectMemorySize=2147483648, -XX:G1HeapRegionSize=4m, -XX:InitiatingHeapOccupancyPercent=30, -XX:G1ReservePercent=15, -Des.path.home=/usr/share/elasticsearch, -Des.path.conf=/etc/elasticsearch, -Des.distribution.flavor=default, -Des.distribution.type=rpm, -Des.bundled_jdk=true]
[2021-09-24T21:58:53,504][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [aggs-matrix-stats]
[2021-09-24T21:58:53,505][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [analysis-common]
[2021-09-24T21:58:53,505][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [constant-keyword]
[2021-09-24T21:58:53,506][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [frozen-indices]
[2021-09-24T21:58:53,506][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [ingest-common]
[2021-09-24T21:58:53,506][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [ingest-geoip]
[2021-09-24T21:58:53,506][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [ingest-user-agent]
[2021-09-24T21:58:53,507][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [kibana]
[2021-09-24T21:58:53,507][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [lang-expression]
[2021-09-24T21:58:53,507][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [lang-mustache]
[2021-09-24T21:58:53,508][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [lang-painless]
[2021-09-24T21:58:53,508][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [mapper-extras]
[2021-09-24T21:58:53,508][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [mapper-version]
[2021-09-24T21:58:53,508][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [parent-join]
[2021-09-24T21:58:53,509][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [percolator]
[2021-09-24T21:58:53,509][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [rank-eval]
[2021-09-24T21:58:53,509][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [reindex]
[2021-09-24T21:58:53,510][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [repositories-metering-api]
[2021-09-24T21:58:53,510][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [repository-encrypted]
[2021-09-24T21:58:53,510][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [repository-url]

...

[2021-09-24T21:58:53,520][INFO ][o.e.p.PluginsService     ] [es-coordinater] loaded module [x-pack-watcher]
[2021-09-24T21:58:53,521][INFO ][o.e.p.PluginsService     ] [es-coordinater] no plugins loaded
[2021-09-24T21:58:53,576][INFO ][o.e.e.NodeEnvironment    ] [es-coordinater] using [1] data paths, mounts [[/ (/dev/nvme0n1p1)]], net usable_space [27.7gb], net total_space [29.9gb], types [xfs]
[2021-09-24T21:58:53,577][INFO ][o.e.e.NodeEnvironment    ] [es-coordinater] heap size [4gb], compressed ordinary object pointers [true]
[2021-09-24T21:58:53,665][INFO ][o.e.n.Node               ] [es-coordinater] node name [es-coordinater], node ID [OdC-Qkv1Tz6vrC7Zw3scjw], cluster name [es-demo], roles [remote_cluster_client, ml, ingest]
[2021-09-24T21:58:59,564][INFO ][o.e.x.m.p.l.CppLogMessageHandler] [es-coordinater] [controller/3368] [Main.cc@117] controller (64 bit): Version 7.14.1 (Build 696c4ee37e496c) Copyright (c) 2021 Elasticsearch BV
[2021-09-24T21:59:00,079][INFO ][o.e.x.s.a.s.FileRolesStore] [es-coordinater] parsed [0] roles from file [/etc/elasticsearch/roles.yml]
[2021-09-24T21:59:00,898][INFO ][o.e.i.g.LocalDatabases   ] [es-coordinater] initialized default databases [[GeoLite2-Country.mmdb, GeoLite2-City.mmdb, GeoLite2-ASN.mmdb]], config databases [[]] and watching [/etc/elasticsearch/ingest-geoip] for changes
[2021-09-24T21:59:00,900][INFO ][o.e.i.g.DatabaseRegistry ] [es-coordinater] initialized database registry, using geoip-databases directory [/tmp/elasticsearch-1460899445039453400/geoip-databases/OdC-Qkv1Tz6vrC7Zw3scjw]
[2021-09-24T21:59:01,761][INFO ][o.e.t.NettyAllocator     ] [es-coordinater] creating NettyAllocator with the following configs: [name=elasticsearch_configured, chunk_size=1mb, suggested_max_allocation_size=1mb, factors={es.unsafe.use_netty_default_chunk_and_page_size=false, g1gc_enabled=true, g1gc_region_size=4mb}]
[2021-09-24T21:59:01,858][INFO ][o.e.d.DiscoveryModule    ] [es-coordinater] using discovery type [zen] and seed hosts providers [settings]
[2021-09-24T21:59:02,508][INFO ][o.e.g.DanglingIndicesState] [es-coordinater] gateway.auto_import_dangling_indices is disabled, dangling indices will not be automatically detected or imported and must be managed manually
[2021-09-24T21:59:03,193][INFO ][o.e.n.Node               ] [es-coordinater] initialized
[2021-09-24T21:59:03,194][INFO ][o.e.n.Node               ] [es-coordinater] starting ...
[2021-09-24T21:59:03,338][INFO ][o.e.t.TransportService   ] [es-coordinater] publish_address {10.10.1.111:9300}, bound_addresses {10.10.1.111:9300}
[2021-09-24T21:59:03,474][INFO ][o.e.b.BootstrapChecks    ] [es-coordinater] bound or publishing to a non-loopback address, enforcing bootstrap checks
[2021-09-24T21:59:05,877][INFO ][o.e.c.s.ClusterApplierService] [es-coordinater] master node changed {previous [], current [{data03}{d2ZNVc4gQAmpMhbd0s8Rmw}{O8BlYAOfSw2GU8aANyAJtg}{10.10.1.155}{10.10.1.155:9300}{cdfhilmrstw}]}, added {{data03}{d2ZNVc4gQAmpMhbd0s8Rmw}{O8BlYAOfSw2GU8aANyAJtg}{10.10.1.155}{10.10.1.155:9300}{cdfhilmrstw}, {data02}{nftLu9TjTj2NcbIcXNxX3A}{HDfMCWTsRg6B9-js0ZNTuQ}{10.10.1.183}{10.10.1.183:9300}{cdfhilmrstw}}, term: 2, version: 3, reason: ApplyCommitRequest{term=2, version=3, sourceNode={data03}{d2ZNVc4gQAmpMhbd0s8Rmw}{O8BlYAOfSw2GU8aANyAJtg}{10.10.1.155}{10.10.1.155:9300}{cdfhilmrstw}{ml.machine_memory=16423026688, ml.max_open_jobs=512, xpack.installed=true, ml.max_jvm_size=4294967296, transform.node=true}}
[2021-09-24T21:59:05,941][INFO ][o.e.h.AbstractHttpServerTransport] [es-coordinater] publish_address {10.10.1.111:9200}, bound_addresses {10.10.1.111:9200}
[2021-09-24T21:59:05,941][INFO ][o.e.n.Node               ] [es-coordinater] started
[2021-09-24T21:59:07,036][INFO ][o.e.x.s.a.TokenService   ] [es-coordinater] refresh keys
[2021-09-24T21:59:07,230][INFO ][o.e.x.s.a.TokenService   ] [es-coordinater] refreshed keys
[2021-09-24T21:59:07,942][INFO ][o.e.c.s.ClusterApplierService] [es-coordinater] added {{data01}{uCaxGGW-R2-nOYwW2OKJWg}{wbG_zTyES1u0o_RZ__Ny9Q}{10.10.1.254}{10.10.1.254:9300}{cdfhilmrstw}}, term: 2, version: 27, reason: ApplyCommitRequest{term=2, version=27, sourceNode={data03}{d2ZNVc4gQAmpMhbd0s8Rmw}{O8BlYAOfSw2GU8aANyAJtg}{10.10.1.155}{10.10.1.155:9300}{cdfhilmrstw}{ml.machine_memory=16423026688, ml.max_open_jobs=512, xpack.installed=true, ml.max_jvm_size=4294967296, transform.node=true}}
[2021-09-24T21:59:09,352][INFO ][o.e.l.LicenseService     ] [es-coordinater] license [8fd351a8-97a0-4631-9d8f-1f5e6005115d] mode [basic] - valid
[2021-09-24T21:59:09,354][INFO ][o.e.x.s.s.SecurityStatusChangeListener] [es-coordinater] Active license is now [BASIC]; Security is enabled
[2021-09-24T21:59:09,425][WARN ][o.e.x.s.a.AuditTrailService] [es-coordinater] Auditing logging is DISABLED because the currently active license [BASIC] does not permit it
[2021-09-24T21:59:12,253][INFO ][o.e.i.g.DatabaseRegistry ] [es-coordinater] downloading geoip database [GeoLite2-ASN.mmdb] to [/tmp/elasticsearch-1460899445039453400/geoip-databases/OdC-Qkv1Tz6vrC7Zw3scjw/GeoLite2-ASN.mmdb.tmp.gz]
[2021-09-24T21:59:12,939][INFO ][o.e.i.g.DatabaseRegistry ] [es-coordinater] database file changed [/tmp/elasticsearch-1460899445039453400/geoip-databases/OdC-Qkv1Tz6vrC7Zw3scjw/GeoLite2-ASN.mmdb], reload database...
[2021-09-24T21:59:18,009][INFO ][o.e.i.g.DatabaseRegistry ] [es-coordinater] downloading geoip database [GeoLite2-City.mmdb] to [/tmp/elasticsearch-1460899445039453400/geoip-databases/OdC-Qkv1Tz6vrC7Zw3scjw/GeoLite2-City.mmdb.tmp.gz]
[2021-09-24T21:59:19,019][INFO ][o.e.i.g.DatabaseRegistry ] [es-coordinater] downloading geoip database [GeoLite2-Country.mmdb] to [/tmp/elasticsearch-1460899445039453400/geoip-databases/OdC-Qkv1Tz6vrC7Zw3scjw/GeoLite2-Country.mmdb.tmp.gz]
[2021-09-24T21:59:19,149][INFO ][o.e.i.g.DatabaseRegistry ] [es-coordinater] database file changed [/tmp/elasticsearch-1460899445039453400/geoip-databases/OdC-Qkv1Tz6vrC7Zw3scjw/GeoLite2-Country.mmdb], reload database...
[2021-09-24T21:59:19,569][INFO ][o.e.i.g.DatabaseRegistry ] [es-coordinater] database file changed [/tmp/elasticsearch-1460899445039453400/geoip-databases/OdC-Qkv1Tz6vrC7Zw3scjw/GeoLite2-City.mmdb], reload database...
[2021-09-24T22:00:05,995][INFO ][o.e.x.s.s.SecurityIndexManager] [es-coordinater] security index does not exist, creating [.security-7] with alias [.security]
[2021-09-24T22:00:21,099][INFO ][o.e.x.s.a.AuthenticationService] [es-coordinater] Authentication of [elastic] was terminated by realm [reserved] - failed to authenticate user [elastic]
```
